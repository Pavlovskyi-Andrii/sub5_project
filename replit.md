# Garmin Connect to Google Sheets Sync

## Обзор проекта
Python скрипт для автоматической синхронизации данных тренировок из Garmin Connect в Google Таблицы. Предназначен для спортсменов, которые хотят собирать и анализировать свои тренировочные данные в удобном формате.

## Последние изменения
- **13.10.2025**: Оптимизация логики синхронизации
  - ✅ Автоматическое определение столбца по дате из строки 1 (недели начинаются с субботы)
  - ✅ Синхронизация ТОЛЬКО последней (самой новой) недели
  - ✅ Понедельник (Становая + плавание): динамический поиск строк для длительности тренировок
  - ✅ BatchUpdater класс для оптимизации API запросов (решена проблема квоты Google Sheets)
  - ✅ Универсальная логика без хардкода строк - работает с любой структурой таблицы
  
- **09.10.2025**: Полностью переработан скрипт для работы с существующей структурой "ВЕЛ БЕГ"
  - ✅ Реализована авторизация в Garmin Connect с кешированием сессии
  - ✅ Интеграция с Google Sheets через Service Account
  - ✅ Интеллектуальный поиск дат в столбце E (заголовки недель + строки блоков)
  - ✅ Автоматическое распознавание тренировочных блоков
  - ✅ Запись данных велосипеда: средние ваты, Normalized Power, скорость, каденс, ЧСС
  - ✅ Запись данных бега: время, расстояние, темп, ЧСС
  - ✅ Специальная обработка субботы (2 вел + 1 бег) с форматом через слеш
  - ✅ Корректная запись "Бег брик" и "ЧСС бег" для субботы
  - ✅ Форматирование данных (темп мин/км, время ЧЧ:ММ:СС, скорость км/ч)

## Архитектура проекта

### Структура файлов
- `main.py` - основной скрипт синхронизации
- `.env.example` - пример файла с переменными окружения
- `.gitignore` - игнорируемые файлы Git
- `README.md` - документация на русском языке
- `replit.md` - документация проекта

### Зависимости
- `garminconnect` - библиотека для подключения к Garmin Connect API
- `gspread` - библиотека для работы с Google Sheets API
- `oauth2client` - аутентификация OAuth2 для Google API
- `python-dotenv` - загрузка переменных окружения

### Данные велосипеда (лист "Вел")
- Дата тренировки
- Средние ваты
- Normalized Power
- Средняя скорость (км/ч)
- Частота вращения педалей (каденс)
- Средняя ЧСС
- Поля для ручного заполнения: субъективное ощущение, бег брик, ЧСС бег, TTV dist, TTV time

### Данные бега (лист "Бег")
- Дата тренировки
- Время тренировки
- Расстояние (км)
- Средний темп (мин/км)
- Средняя ЧСС
- Поля для ручного заполнения: усталость (в течении дня, во время, после), TTR dist, TTR time, вариабельность СР

## Настройка

### Переменные окружения (Replit Secrets)
1. `GARMIN_EMAIL` - email для входа в Garmin Connect
2. `GARMIN_PASSWORD` - пароль от Garmin Connect
3. `GOOGLE_SHEET_URL` - URL Google Таблицы
4. `SERVICE_ACCOUNT_JSON` - JSON ключ Service Account из Google Cloud
5. `DAYS_TO_SYNC` - количество дней для синхронизации (опционально, по умолчанию 7)

### Google Cloud Setup
1. Создать проект в Google Cloud Console
2. Включить Google Sheets API
3. Создать Service Account и скачать JSON ключ
4. Поделиться Google Таблицей с email service account

## Особенности реализации
- **Автоматическое определение столбца**: парсинг строки 1 для поиска дат начала недель
- **Синхронизация только последней недели**: скрипт находит самую новую неделю и обновляет только её данные
- **Динамический поиск строк**: универсальная логика без хардкода, работает с любой структурой таблицы
- **BatchUpdater класс**: накопление всех обновлений и отправка одним batch_update запросом (оптимизация квоты API)
- **Кеширование сессии Garmin**: сохранение SESSION_SECRET для избежания повторной авторизации
- **Поддержка всех типов тренировок**: велосипед, бег, силовая, плавание
- Безопасное хранение учетных данных через переменные окружения
- Форматирование темпа бега из м/с в мин/км
- Форматирование времени тренировки в формат ЧЧ:ММ:СС
- Конвертация скорости велосипеда из м/с в км/ч
- Обработка ошибок и информативные логи

## Пользовательские предпочтения
- Язык: Русский
- Формат данных: специфичные поля для триатлона (ваты, каденс, темп и т.д.)
- Требуются поля для ручного заполнения субъективных данных
